<div id="tfg-pro-widget" style="max-width:1080px;margin:30px auto;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;">
  <div style="border:1px solid #e6edf5;border-radius:14px;background:#ffffff;box-shadow:0 10px 25px rgba(41,128,185,0.08),0 2px 6px rgba(0,0,0,0.05);overflow:hidden;position:relative;">
    <div style="padding:16px 18px;background:linear-gradient(135deg,#eaf4ff 0%,#f7fbff 100%);border-bottom:1px solid #e6edf5;display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div>
        <div style="margin:0;color:#1f2d3d;font-weight:700;font-size:18px;">Generador académico de palabras clave (ES/EN)</div>
        <div style="margin:6px 0 0;color:#5b6b7b;font-size:12px;">Sustantivos y frases nominales · n-gramas 1–4 · sinónimos/relacionados · ES→EN</div>
      </div>
      <button id="tfgp-help" type="button" style="border:1px solid #2980b9;background:#2980b9;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">Ayuda</button>
    </div>

    <div style="padding:16px 18px;">
      <div id="tfgp-main-grid" style="display:table;width:100%;table-layout:fixed;margin:0 -6px 8px -6px;">
        <div id="tfgp-col-left" style="display:table-cell;vertical-align:top;padding:0 6px;width:32%;">
          <div style="margin-bottom:10px;">
            <div style="font-size:12px;color:#5b6b7b;margin-bottom:6px;">Dominio</div>
            <select id="tfgp-domain" style="width:100%;padding:10px 12px;border:1px solid #cfdae6;border-radius:10px;font-size:14px;background:#fff;">
              <option value="general">General</option>
              <option value="cs">Informática / IA</option>
              <option value="bio">Biomedicina</option>
              <option value="edu">Educación</option>
              <option value="biz">Empresa/Finanzas</option>
              <option value="eng">Ingeniería</option>
              <option value="agro">Agricultura / IoT</option>
            </select>
          </div>
          <div style="display:flex;gap:6px;">
            <div style="flex:1;">
              <div style="font-size:12px;color:#5b6b7b;margin-bottom:6px;">Nº keywords</div>
              <select id="tfgp-kcount" style="width:100%;padding:10px 12px;border:1px solid #cfdae6;border-radius:10px;font-size:14px;background:#fff;">
                <option>4</option><option>6</option><option selected>8</option><option>10</option><option>12</option>
              </select>
            </div>
            <div style="flex:1;">
              <div style="font-size:12px;color:#5b6b7b;margin-bottom:6px;">Idioma base</div>
              <select id="tfgp-lang" style="width:100%;padding:10px 12px;border:1px solid #cfdae6;border-radius:10px;font-size:14px;background:#fff;">
                <option value="es" selected>Español</option>
                <option value="en">English</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label style="display:block;font-size:12px;color:#5b6b7b;margin-bottom:6px;"><input id="tfgp-keepAcr" type="checkbox" checked style="margin-right:6px;">Expandir acrónimos</label>
            <label style="display:block;font-size:12px;color:#5b6b7b;margin-bottom:6px;"><input id="tfgp-useSyn" type="checkbox" checked style="margin-right:6px;">Añadir sinónimos/relacionados</label>
            <label style="display:block;font-size:12px;color:#5b6b7b;margin-bottom:6px;"><input id="tfgp-cleanVerbs" type="checkbox" checked style="margin-right:6px;">Evitar verbos/adjetivos</label>
          </div>

          <div style="margin-top:10px;">
            <div style="font-size:12px;color:#5b6b7b;margin-bottom:6px;">Calidad de coincidencia</div>
            <div style="height:8px;border-radius:999px;background:#eef2f7;overflow:hidden;"><div id="tfgp-meter" style="height:100%;background:linear-gradient(90deg,#59a2db,#2980b9);width:0%;transition:width .3s ease;"></div></div>
          </div>

          <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:6px;">
            <button id="tfgp-generate" type="button" style="border:1px solid #2980b9;background:#2980b9;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">Generar</button>
            <button id="tfgp-clear" type="button" style="border:1px solid #d1dbea;background:#f6f9fc;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">Limpiar</button>
            <button id="tfgp-copy-es" type="button" style="border:1px solid #d1dbea;background:#f6f9fc;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">Copiar ES</button>
            <button id="tfgp-copy-en" type="button" style="border:1px solid #d1dbea;background:#f6f9fc;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">Copy EN</button>
            <button id="tfgp-export" type="button" style="border:1px solid #d1dbea;background:#f6f9fc;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">CSV</button>
          </div>

          <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:6px;">
            <button id="tfgp-open-scholar-es" type="button" style="border:1px solid #1f6feb;background:#1f6feb;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">Scholar (ES)</button>
            <button id="tfgp-open-scholar-en" type="button" style="border:1px solid #0a58ca;background:#0a58ca;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">Scholar (EN)</button>
            <button id="tfgp-open-jstor-es" type="button" style="border:1px solid #654321;background:#654321;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">JSTOR (ES)</button>
            <button id="tfgp-open-jstor-en" type="button" style="border:1px solid #4c3521;background:#4c3521;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">JSTOR (EN)</button>
            <button id="tfgp-open-pubmed-es" type="button" style="border:1px solid #0b8457;background:#0b8457;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">PubMed (ES)</button>
            <button id="tfgp-open-pubmed-en" type="button" style="border:1px solid #086343;background:#086343;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">PubMed (EN)</button>
            <button id="tfgp-open-perplexity" type="button" style="border:1px solid #111;background:#111;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer;">Perplexity (10–15)</button>
          </div>
        </div>

        <div id="tfgp-col-right" style="display:table-cell;vertical-align:top;padding:0 6px;width:68%;">
          <div style="margin-bottom:10px;">
            <div style="font-size:12px;color:#5b6b7b;margin-bottom:6px;">Título</div>
            <input id="tfgp-title" type="text" placeholder="Escribe el título del TFG" style="width:100%;padding:10px 12px;border:1px solid #cfdae6;border-radius:10px;font-size:14px;background:#fff;" />
          </div>
          <div id="tfgp-sub-grid" style="display:table;width:100%;table-layout:fixed;margin:0 -6px;">
            <div id="tfgp-subcol-abs" style="display:table-cell;vertical-align:top;padding:0 6px;">
              <div style="font-size:12px;color:#5b6b7b;margin:8px 0 6px 0;">Resumen / Abstract</div>
              <div id="tfgp-abs" contenteditable="true" style="width:100%;min-height:120px;border:1px solid #cfdae6;border-radius:10px;padding:8px;background:#fff;font-size:13px;white-space:pre-wrap;"></div>
            </div>
            <div id="tfgp-subcol-body" style="display:table-cell;vertical-align:top;padding:0 6px;">
              <div style="font-size:12px;color:#5b6b7b;margin:8px 0 6px 0;">Contenido / Notas</div>
              <div id="tfgp-body" contenteditable="true" style="width:100%;min-height:120px;border:1px solid #cfdae6;border-radius:10px;padding:8px;background:#fff;font-size:13px;white-space:pre-wrap;"></div>
            </div>
          </div>

          <div style="height:1px;background:#eef2f7;margin:14px 0;"></div>

          <div style="margin-bottom:12px;">
            <div style="font-size:12px;color:#5b6b7b;margin-bottom:6px;">Español</div>
            <div id="tfgp-chips-es" style="padding:8px;border:1px dashed #cfd8e3;border-radius:10px;min-height:46px;background:#fbfdff;"></div>
          </div>

          <div style="margin-bottom:12px;">
            <div style="font-size:12px;color:#5b6b7b;margin-bottom:6px;">English</div>
            <div id="tfgp-chips-en" style="padding:8px;border:1px dashed #cfd8e3;border-radius:10px;min-height:46px;background:#fbfdff;"></div>
          </div>

          <div style="font-size:12px;color:#66788a;">Consejo: usa términos nucleares (sustantivos compuestos); valida con Scholar/JSTOR/PubMed/Perplexity.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="tfgp-help-overlay" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.35);z-index:9998;"></div>
  <div id="tfgp-help-panel" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:min(92vw,560px);background:#ffffff;border:1px solid #d6e4f0;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.15);padding:14px;z-index:9999;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;">
      <div style="font-weight:bold;color:#1f2d3d;">Cómo usar</div>
      <button id="tfgp-help-close" type="button" style="border:1px solid #e0e0e0;background:#f8f9fa;border-radius:8px;padding:4px 8px;cursor:pointer;">Cerrar</button>
    </div>
    <div style="font-size:13px;color:#2c3e50;line-height:1.45;">
      <ol style="margin:0 0 8px 18px;padding:0;">
        <li>Escribe título, resumen y contenido. Pulsa Generar.</li>
        <li>Se extraen sustantivos y frases nominales, se eliminan verbos/adjetivos y se añaden sinónimos.</li>
        <li>Edita las pastillas con clic; “×” elimina. Copia o exporta CSV.</li>
        <li>Usa Scholar/JSTOR/PubMed en el idioma deseado o Perplexity para obtener 10–15 artículos con resumen, uso en TFG, tecnologías y citas IEEE/BibTeX.</li>
      </ol>
    </div>
  </div>
</div>

<script type="text/javascript">
(function(){
  var hasJQ=!!(window.jQuery&&typeof window.jQuery==='function');
  function nrm(s){return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[“”"‘’’]/g,'').replace(/\s+/g,' ').trim();}
  function uniq(a){var m={},o=[];for(var i=0;i<a.length;i++){var k=nrm((a[i]||'').replace(/\s+/g,' ').trim());if(!k)continue;if(!m[k]){m[k]=1;o.push(a[i]);}}return o;}
  function prettyES(s){var t=nrm(s).split(' '), out=[]; for(var i=0;i<t.length;i++){var w=t[i]; if(w==='led') out.push('LED'); else if(w==='dht22') out.push('DHT22'); else if(w==='arduino') out.push('Arduino'); else if(w==='uno'&&i>0&&t[i-1]==='arduino') out.push('Uno'); else if(w==='solanum'&&i+1<t.length&&t[i+1]==='tuberosum'){out.push('Solanum');} else if(w==='tuberosum'&&i>0&&t[i-1]==='solanum'){out.push('tuberosum');} else out.push(w);} var j=out.join(' '); return j.replace(/\b([a-z])/g,function(m,c){return c.toLowerCase();}).replace(/^./,function(m){return m.toUpperCase();});}
  function prettyEN(s){var t=nrm(s).split(' '), out=[]; for(var i=0;i<t.length;i++){var w=t[i]; if(w==='led') out.push('LED'); else if(w==='dht22') out.push('DHT22'); else if(w==='arduino') out.push('Arduino'); else if(w==='uno'&&i>0&&t[i-1]==='arduino') out.push('Uno'); else if(w==='solanum'&&i+1<t.length&&t[i+1]==='tuberosum'){out.push('Solanum');} else if(w==='tuberosum'&&i>0&&t[i-1]==='solanum'){out.push('tuberosum');} else out.push(w);} var j=out.join(' '); return j.replace(/\b([a-z])/g,function(m,c){return c.toLowerCase();}).replace(/^./,function(m){return m.toUpperCase();});}

  var STOP_ES=("a,al,ante,antes,como,con,contra,de,del,desde,donde,el,la,los,las,en,entre,era,es,esta,este,estos,estas,fue,ha,han,hasta,hay,le,les,lo,mas,me,mi,muy,nos,nuestro,nuestra,para,por,que,quien,quienes,se,si,sin,sobre,son,su,sus,un,una,uno,unos,unas,y,o,u,mediante,tras,ademas,asi,cada,cual,cuales,cuyo,cuyos,cuyas,hacia,segun,tal,tales,del,al,siendo,ser,haber,este,esta,estos,estas,correcto,correcta,dentro,capacidad,resultados,demuestran,presente,presenta,trabajo,proyecto,objetivo,objetivos,util,utiles").split(',');
  var STOP_EN=("a,an,and,are,as,at,be,by,for,from,has,have,in,is,of,on,or,that,the,these,this,those,to,was,were,with,within,into,via,using,use,study,results,show,shows,present,presents,project,work,objective,aim").split(',');
  var BAN_PHRASES_ES=("pruebas experimentales,los resultados,este trabajo,el presente trabajo,demuestran,validando,validacion,capacidad del prototipo,correcto desarrollo,dentro de,debido a,en torno a").split(',');
  var BAN_PHRASES_EN=("experimental results,our work,this work,demonstrate,validating").split(',');
  var ACR={"ia":"inteligencia artificial","ml":"aprendizaje automatico","dl":"aprendizaje profundo","pln":"procesamiento de lenguaje natural","nlp":"procesamiento de lenguaje natural","cv":"vision por computador","iot":"internet de las cosas","vr":"realidad virtual","ar":"realidad aumentada","se":"ingenieria de software","ux":"experiencia de usuario","ui":"interfaz de usuario","gis":"sistemas de informacion geografica","sig":"sistemas de informacion geografica","etl":"extraccion transformacion carga","cnn":"redes neuronales convolucionales","rnn":"redes neuronales recurrentes","llm":"modelo de lenguaje grande","dht22":"sensor dht22"};
  var DOMAINS={general:[],cs:["aprendizaje automatico","inteligencia artificial","redes neuronales","vision por computador","procesamiento de lenguaje natural","mineria de datos","sistemas distribuidos","computacion en la nube","ciberseguridad","privacidad","sistemas de recomendacion","transformers","modelos de lenguaje"],bio:["imagen medica","bioinformatica","biomarcadores","medicina personalizada","ensayo clinico","genomica","proteomica"],edu:["analitica de aprendizaje","evaluacion formativa","gamificacion","competencias digitales"],biz:["deteccion de fraude","series temporales","cadena de suministro","fintech","gestion de riesgos"],eng:["gemelo digital","mantenimiento predictivo","industria 4.0","sistemas embebidos","robotica","control pid","simulacion"],agro:["agricultura urbana","invernadero","armario de cultivo","riego por goteo","control de clima","humedad del suelo","arduino","arduino uno","led grow","dht22","sensores ambientales","automatizacion de cultivo","solanum tuberosum","soberania alimentaria","sostenibilidad urbana"]};
  var GLOSS_PH={"agricultura urbana":"urban agriculture","soberania alimentaria":"food sovereignty","sostenibilidad":"sustainability","armario de cultivo":"growth chamber","invernadero":"greenhouse","automatizacion de cultivo":"crop automation","automatizacion":"automation","arduino uno":"Arduino Uno","arduino":"Arduino","bomba de agua":"water pump","riego por goteo":"drip irrigation","panel led":"LED panel","iluminacion led programable":"programmable LED lighting","iluminacion led":"LED lighting","iluminacion":"lighting","sistema de ventilacion":"ventilation system","sensor dht22":"DHT22 sensor","humedad ambiental":"ambient humidity","humedad del sustrato":"substrate moisture","humedad del suelo":"soil moisture","temperatura":"temperature","intensidad luminica":"light intensity","sistema de monitorizacion":"monitoring system","sistema de control":"control system","puente h":"H-bridge","solanum tuberosum":"Solanum tuberosum","prototipo funcional":"functional prototype","hardware libre":"open hardware","control automatico":"automatic control","aprendizaje automatico":"machine learning"};
  var GLOSS_W={"analisis":"analysis","diseno":"design","implementacion":"implementation","arquitectura":"architecture","evaluacion":"evaluation","desarrollo":"development","modelo":"model","metodologia":"methodology","algoritmo":"algorithm","sistema":"system","aplicacion":"application","prototipo":"prototype","rendimiento":"performance","precision":"accuracy","fiabilidad":"reliability","seguridad":"security","privacidad":"privacy","usabilidad":"usability","experiencia":"experience","interfaz":"interface","mineria":"mining","nube":"cloud","optimizacion":"optimization","simulacion":"simulation","deteccion":"detection","prediccion":"prediction","recomendacion":"recommendation","energia":"energy","salud":"health","finanzas":"finance","robotica":"robotics","humedad":"humidity","temperatura":"temperature","luz":"light","ventilacion":"ventilation","riego":"irrigation","sustrato":"substrate","cultivo":"cultivation","tuberculo":"tuber","programable":"programmable","rango":"range","rangos":"ranges","optimo":"optimal","optimos":"optimal","requerido":"required","requeridos":"required","variable":"variable","variables":"variables","ambiente":"environment","ambiental":"environmental","panel":"panel","led":"LED","coste":"cost","disenado":"designed"};
  var SYN_EN={"urban agriculture":["urban farming"],"growth chamber":["controlled-environment chamber"],"soil moisture":["soil water content","substrate moisture"],"drip irrigation":["microirrigation"],"LED panel":["LED grow light","LED lighting"],"Arduino":["microcontroller"],"DHT22 sensor":["AM2302 sensor"],"control system":["closed-loop control"],"monitoring system":["environmental monitoring"],"greenhouse":["controlled environment"],"food sovereignty":["food security","food systems"],"open hardware":["open-source hardware"]};
  var SYN_ES={"agricultura urbana":["agricultura urbana","agricultura en ciudades"],"armario de cultivo":["camara de crecimiento","camara climatica"],"humedad del suelo":["contenido de agua del suelo","humedad del sustrato"],"riego por goteo":["microirrigacion"],"panel led":["iluminacion led","luz de crecimiento led"],"arduino":["microcontrolador arduino"],"sensor dht22":["sensor am2302"],"sistema de control":["control en lazo cerrado"],"sistema de monitorizacion":["monitorizacion ambiental"],"invernadero":["ambiente controlado"],"soberania alimentaria":["seguridad alimentaria"],"hardware libre":["hardware de codigo abierto"]};

  function es2enRule(w){var b=nrm(w); if(GLOSS_W[b]) return GLOSS_W[b]; if(/ciones$/.test(b)) return b.replace(/ciones$/,'tions'); if(/cion$/.test(b)) return b.replace(/cion$/,'tion'); if(/sion$/.test(b)) return b.replace(/sion$/,'sion'); if(/idades$/.test(b)) return b.replace(/idades$/,'ities'); if(/idad$/.test(b)) return b.replace(/idad$/,'ity'); if(/icas$/.test(b)) return b.replace(/icas$/,'ics'); if(/icos$/.test(b)) return b.replace(/icos$/,'ics'); if(/ica$/.test(b)) return b.replace(/ica$/,'ic'); if(/ico$/.test(b)) return b.replace(/ico$/,'ic'); if(/mente$/.test(b)) return b.replace(/mente$/,'ly'); if(/logia$/.test(b)) return b.replace(/logia$/,'logy'); if(/grafia$/.test(b)) return b.replace(/grafia$/,'graphy'); return b;}
  function expandAcronyms(t,keep){if(!keep) return t; var s=' '+nrm(t)+' '; for(var k in ACR){var r=new RegExp(' '+k+' ','g'); if(r.test(s)) s=s.replace(r,' '+ACR[k]+' ');} return s.trim();}
  function tokenize(text){return nrm(text).replace(/[(){}\[\],;.:\/\\|]/g,' ').split(' ').filter(Boolean);}
  function grams(tokens,min,max){var out=[]; for(var i=0;i<tokens.length;i++){for(var j=min;j<=max && i+j<=tokens.length;j++){out.push(tokens.slice(i,i+j).join(' '));}} return out;}
  function isStopWord(w,lang){var set=(lang==='en')?STOP_EN:STOP_ES; for(var i=0;i<set.length;i++){if(nrm(w)===set[i]) return true;} return false;}
  function bannedPhrase(g,lang){var arr=(lang==='en')?BAN_PHRASES_EN:BAN_PHRASES_ES; var x=nrm(g); for(var i=0;i<arr.length;i++){ if(x.indexOf(arr[i])>=0) return true;} return false;}
  function looksNoun(w,lang){var b=nrm(w); if(!b) return false; if(isStopWord(b,lang)) return false; if(/\d/.test(b)) return true; if(lang==='en'){ if(/(tion|tions|ment|sion|ness|ity|model|models|system|systems|sensor|sensors|light|humidity|temperature|greenhouse|chamber|control|monitoring)$/i.test(b)) return true; if(/ing$/.test(b)) return false; return b.length>2; } else { if(/(cion|ciones|miento|mientos|sion|siones|dad|dades|logia|grafia|aje|ajes|or|ores|ora|oras|ista|istas|ente|entes|sistema|sensor|bomba|riego|suelo|sustrato|humedad|temperatura|luminica|invernadero|cultivo|camara|prototipo)$/i.test(b)) return true; if(/mente$/.test(b)) return false; return b.length>2; } }
  function keepNounGram(g,lang){var parts=g.split(' '); for(var i=0;i<parts.length;i++){ if(!looksNoun(parts[i],lang)) return false; } return true;}

  function score(text,domain,lang,clean){
    var tokens=tokenize(text), cand=[], i;
    for(i=1;i<=4;i++) cand=cand.concat(grams(tokens,i,i));
    cand=cand.filter(function(g){return g.length>=3 && !bannedPhrase(g,lang) && keepNounGram(g,lang);});
    var freq={},deg={};
    for(i=0;i<cand.length;i++){var wds=uniq(cand[i].split(' '));var L=wds.length;for(var k=0;k<wds.length;k++){var t=wds[k]; if(clean && isStopWord(t,lang)) continue; freq[t]=(freq[t]||0)+1; deg[t]=(deg[t]||0)+(L-1);}}
    var ws={}; for(var k in freq){ws[k]=(deg[k]||0)/(freq[k]||1)+freq[k];}
    var baseBoost=(DOMAINS[domain]||[]).map(nrm);
    var ranked=[];
    for(i=0;i<cand.length;i++){
      var g=cand[i], parts=g.split(' '), s=0, n=nrm(g);
      for(var p=0;p<parts.length;p++){ s+=(ws[parts[p]]||0); }
      for(var b=0;b<baseBoost.length;b++){ if(n.indexOf(baseBoost[b])>=0) s+=2.0; }
      if(/[A-Za-z]*\d{2,}/.test(g)) s+=1.0;
      if(n.split(' ').length>=3) s+=0.6;
      ranked.push({term:g,score:s});
    }
    ranked.sort(function(a,b){return b.score-a.score;});
    return ranked;
  }

  function topK(scored,k){var out=[],i=0,seen={}; while(out.length<k && i<scored.length){var t=scored[i].term, key=nrm(t); if(!seen[key]){seen[key]=1; out.push(t);} i++;} return out;}

  function translateES2EN(list){
    var out=[];
    for(var i=0;i<list.length;i++){
      var base=' '+nrm(list[i])+' ';
      base=base.replace(/ de las /g,' of the ').replace(/ de los /g,' of the ').replace(/ de la /g,' of the ').replace(/ del /g,' of the ').replace(/ de /g,' of ').replace(/ para /g,' for ').replace(/ por /g,' by ').replace(/ en /g,' in ').replace(/ y /g,' and ').trim();
      if(GLOSS_PH[base]){ out.push(GLOSS_PH[base]); continue; }
      var parts=base.split(' '), tmp=[];
      for(var p=0;p<parts.length;p++){
        var w=parts[p]; if(!w) continue;
        if(GLOSS_PH[w]) tmp.push(GLOSS_PH[w]);
        else if(GLOSS_W[w]) tmp.push(GLOSS_W[w]);
        else if(/^(of|the|for|by|in|and)$/.test(w)) tmp.push(w);
        else tmp.push(es2enRule(w));
      }
      out.push(tmp.join(' '));
    }
    return uniq(out);
  }

  function addSyn(list,lang){
    var res=list.slice();
    for(var i=0;i<list.length;i++){
      var key=nrm(list[i]);
      if(lang==='en' && SYN_EN[key]) res=res.concat(SYN_EN[key]);
      if(lang==='es' && SYN_ES[key]) res=res.concat(SYN_ES[key]);
    }
    return uniq(res);
  }

  function formatListES(arr){return arr.map(function(x){return prettyES(x);});}
  function formatListEN(arr){return arr.map(function(x){return prettyEN(x);});}

  function renderChips(id,arr){
    var box=document.getElementById(id); box.innerHTML='';
    for(var i=0;i<arr.length;i++){
      (function(idx){
        var sp=document.createElement('span'); sp.setAttribute('style','display:inline-flex;align-items:center;padding:7px 10px;margin:5px;border-radius:999px;background:#e9f3ff;color:#0e4980;border:1px solid #c6dcff;font-size:12px;cursor:pointer;');
        var txt=document.createElement('span'); txt.appendChild(document.createTextNode(arr[idx]));
        var x=document.createElement('span'); x.appendChild(document.createTextNode('×')); x.setAttribute('style','margin-left:8px;cursor:pointer;font-weight:bold;padding-left:6px;border-left:1px solid rgba(14,73,128,0.25);');
        sp.addEventListener('click',function(e){ if(e.target===x)return; var nv=prompt('Editar palabra clave:', txt.textContent); if(nv!==null){ arr[idx]=(nv||'').replace(/\s+/g,' ').trim(); renderChips(id,arr);} });
        x.addEventListener('click',function(){ arr.splice(idx,1); renderChips(id,arr);});
        sp.appendChild(txt); sp.appendChild(x); box.appendChild(sp);
      })(i);
    }
  }

  function joinText(){var t=document.getElementById('tfgp-title').value||''; var a=document.getElementById('tfgp-abs').innerText||''; var b=document.getElementById('tfgp-body').innerText||''; return [t,a,b].join(' ');}
  function meterTo(p){var m=document.getElementById('tfgp-meter'); if(m) m.style.width=Math.max(5,Math.min(100,p))+'%';}
  function copyText(t){ if(navigator.clipboard&&navigator.clipboard.writeText){ navigator.clipboard.writeText(t).then(function(){ alert('Copiado al portapapeles.'); },function(){ legacy();}); } else { legacy(); } function legacy(){ var ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); alert('Copiado al portapapeles.'); }catch(e){ alert('No se pudo copiar automáticamente.'); } document.body.removeChild(ta);} }
  function exportCSV(es,en){ var rows=[['es','en']], n=Math.max(es.length,en.length); for(var i=0;i<n;i++){ rows.push([es[i]||'',en[i]||'']); } var csv=rows.map(function(r){return r.map(function(c){var v=String(c||'').replace(/"/g,'""'); return '"'+v+'"';}).join(',');}).join('\r\n'); var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tfg_keywords.csv'; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); document.body.removeChild(a); },0); }

  var ES=[], EN=[];
  function generate(){
    var domain=document.getElementById('tfgp-domain').value;
    var lang=document.getElementById('tfgp-lang').value;
    var keepAcr=document.getElementById('tfgp-keepAcr').checked;
    var useSyn=document.getElementById('tfgp-useSyn').checked;
    var clean=document.getElementById('tfgp-cleanVerbs').checked;
    var raw=joinText(); if(!raw.trim()){ alert('Introduce título o resumen.'); return; }
    var text=expandAcronyms(raw,keepAcr);
    var ranked=score(text,domain,lang,clean);
    var strong=0; for(var i=0;i<ranked.length;i++){ if(ranked[i].score>=4) strong++; }
    meterTo(ranked.length? Math.min(100, Math.round((strong/ranked.length)*100)) : 10);
    var K=parseInt(document.getElementById('tfgp-kcount').value,10)||8;

    var base=topK(ranked, Math.max(2*K, K+6));
    var baseES=base.map(function(x){return nrm(x);});
    if(useSyn){ baseES=addSyn(baseES,'es'); }
    baseES=uniq(baseES);

    ES=formatListES(baseES);

    var enRaw=translateES2EN(baseES);
    if(useSyn) enRaw=addSyn(enRaw,'en');
    EN=formatListEN(enRaw);

    ES=uniq(ES).slice(0,K);
    EN=uniq(EN).slice(0,K);

    renderChips('tfgp-chips-es',ES);
    renderChips('tfgp-chips-en',EN);
  }

  function qList(arr){return encodeURIComponent(arr.slice(0,8).map(function(x){return '"'+x+'"';}).join(' '));}
  function openScholarES(){ window.open('https://scholar.google.com/scholar?hl=es&q='+qList(ES),'_blank'); }
  function openScholarEN(){ window.open('https://scholar.google.com/scholar?hl=en&q='+qList(EN),'_blank'); }
  function openJSTOR(lang){ var q=lang==='en'? qList(EN): qList(ES); window.open('https://www.jstor.org/action/doBasicSearch?Query='+q,'_blank'); }
  function openPubMed(lang){ var q=lang==='en'? qList(EN): qList(ES); window.open('https://pubmed.ncbi.nlm.nih.gov/?term='+q,'_blank'); }

  function domLabel(d){ if(d==='cs')return'Informática/IA'; if(d==='bio')return'Biomedicina'; if(d==='edu')return'Educación'; if(d==='biz')return'Empresa/Finanzas'; if(d==='eng')return'Ingeniería'; if(d==='agro')return'Agricultura/IoT'; return'General'; }
  function trunc(s,n){s=String(s||'').trim(); if(s.length>n)return s.slice(0,n-1)+'…'; return s;}
  function openPerplexity(){
    var t=document.getElementById('tfgp-title').value||'';
    var a=document.getElementById('tfgp-abs').innerText||'';
    var b=document.getElementById('tfgp-body').innerText||'';
    var d=domLabel(document.getElementById('tfgp-domain').value);
    var kwES=ES.slice(0,10).join(', ');
    var kwEN=EN.slice(0,10).join(', ');
    var prompt='Actúa como bibliotecario académico experto. Tema del TFG: "'+trunc(t,180)+'". Dominio: '+d+'. Resumen breve: '+trunc((a||b),380)+'. Palabras clave ES: ['+kwES+']. Keywords EN: ['+kwEN+']. Tarea: encuentra 10–15 artículos académicos muy relevantes (prioriza últimos 10 años; incluye seminales si son imprescindibles). Para cada artículo entrega: 1) título, 2) resumen sencillo (2–3 frases), 3) para qué usarlo en el TFG (justificación en 1 frase), 4) tecnologías/métodos/datasets, 5) enlace DOI/URL, y además 6) la URL original de la fuente (página del editor o repositorio) por separado. Al final, lista todas las referencias primero en formato IEEE y debajo en BibTeX. Responde en español. Evita duplicados y mezcla de idiomas en las citas.';
    window.open('https://www.perplexity.ai/search?q='+encodeURIComponent(prompt),'_blank');
  }

  function showHelp(){ document.getElementById('tfgp-help-overlay').style.display='block'; document.getElementById('tfgp-help-panel').style.display='block'; }
  function hideHelp(){ document.getElementById('tfgp-help-overlay').style.display='none'; document.getElementById('tfgp-help-panel').style.display='none'; }

  function responsiveApply(){
    var w=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;
    var main=document.getElementById('tfgp-main-grid');
    var left=document.getElementById('tfgp-col-left');
    var right=document.getElementById('tfgp-col-right');
    var sub=document.getElementById('tfgp-sub-grid');
    var sa=document.getElementById('tfgp-subcol-abs');
    var sb=document.getElementById('tfgp-subcol-body');
    if(w<=780){
      main.style.display='block';
      left.style.display='block'; left.style.width='100%'; left.style.marginBottom='12px';
      right.style.display='block'; right.style.width='100%';
      sub.style.display='block';
      sa.style.display='block'; sa.style.width='100%'; sa.style.marginBottom='10px';
      sb.style.display='block'; sb.style.width='100%';
    }else{
      main.style.display='table';
      left.style.display='table-cell'; left.style.width='32%'; left.style.marginBottom='0';
      right.style.display='table-cell'; right.style.width='68%';
      sub.style.display='table';
      sa.style.display='table-cell'; sa.style.width=''; sa.style.marginBottom='0';
      sb.style.display='table-cell';
    }
  }

  function bindVanilla(){
    document.getElementById('tfgp-generate').onclick=generate;
    document.getElementById('tfgp-clear').onclick=function(){ document.getElementById('tfgp-title').value=''; document.getElementById('tfgp-abs').innerText=''; document.getElementById('tfgp-body').innerText=''; ES=[]; EN=[]; renderChips('tfgp-chips-es',ES); renderChips('tfgp-chips-en',EN); meterTo(5); };
    document.getElementById('tfgp-copy-es').onclick=function(){ copyText(ES.join(', ')); };
    document.getElementById('tfgp-copy-en').onclick=function(){ copyText(EN.join(', ')); };
    document.getElementById('tfgp-export').onclick=function(){ exportCSV(ES,EN); };
    document.getElementById('tfgp-open-scholar-es').onclick=openScholarES;
    document.getElementById('tfgp-open-scholar-en').onclick=openScholarEN;
    document.getElementById('tfgp-open-jstor-es').onclick=function(){ openJSTOR('es'); };
    document.getElementById('tfgp-open-jstor-en').onclick=function(){ openJSTOR('en'); };
    document.getElementById('tfgp-open-pubmed-es').onclick=function(){ openPubMed('es'); };
    document.getElementById('tfgp-open-pubmed-en').onclick=function(){ openPubMed('en'); };
    document.getElementById('tfgp-open-perplexity').onclick=openPerplexity;
    document.getElementById('tfgp-title').onkeypress=function(e){ var k=e.keyCode||e.which; if(k===13){ e.preventDefault(); generate(); } };
    document.getElementById('tfgp-help').onclick=showHelp;
    document.getElementById('tfgp-help-close').onclick=hideHelp;
    document.getElementById('tfgp-help-overlay').onclick=hideHelp;
    responsiveApply(); window.addEventListener('resize', responsiveApply);
    meterTo(5);
  }

  function bindJQ($){
    $(document).on('click','#tfgp-generate',generate);
    $(document).on('click','#tfgp-clear',function(){ $('#tfgp-title').val(''); $('#tfgp-abs').text(''); $('#tfgp-body').text(''); ES=[]; EN=[]; renderChips('tfgp-chips-es',ES); renderChips('tfgp-chips-en',EN); meterTo(5); });
    $(document).on('click','#tfgp-copy-es',function(){ copyText(ES.join(', ')); });
    $(document).on('click','#tfgp-copy-en',function(){ copyText(EN.join(', ')); });
    $(document).on('click','#tfgp-export',function(){ exportCSV(ES,EN); });
    $(document).on('click','#tfgp-open-scholar-es',openScholarES);
    $(document).on('click','#tfgp-open-scholar-en',openScholarEN);
    $(document).on('click','#tfgp-open-jstor-es',function(){ openJSTOR('es'); });
    $(document).on('click','#tfgp-open-jstor-en',function(){ openJSTOR('en'); });
    $(document).on('click','#tfgp-open-pubmed-es',function(){ openPubMed('es'); });
    $(document).on('click','#tfgp-open-pubmed-en',function(){ openPubMed('en'); });
    $(document).on('click','#tfgp-open-perplexity',openPerplexity);
    $(document).on('keypress','#tfgp-title',function(e){ if((e.keyCode||e.which)===13){ e.preventDefault(); generate(); } });
    $(document).on('click','#tfgp-help',showHelp);
    $(document).on('click','#tfgp-help-close',hideHelp);
    $(document).on('click','#tfgp-help-overlay',hideHelp);
    responsiveApply(); $(window).on('resize', responsiveApply);
    meterTo(5);
  }

  if(hasJQ){ window.jQuery(function($){ bindJQ($);}); } else if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', bindVanilla); } else { bindVanilla(); }
})();
</script>
